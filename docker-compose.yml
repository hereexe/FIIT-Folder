version: '3.8'

services:
  # 1. Backend API (C#)
  api:
    build:
      context: ./backend
      dockerfile: ./Dockerfile
    container_name: fiit_api
    restart: always
    ports:
      - "${API_EXTERNAL_PORT:-8080}:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
      ASPNETCORE_URLS: http://+:8080
      # MongoDB
      MONGODB_CONNECTION_STRING: "mongodb://${MONGO_ROOT_USER:-root}:${MONGO_ROOT_PASSWORD:-password}@mongo:27017/?authSource=admin"
      MONGODB_DATABASE_NAME: "${MONGO_DB_NAME:-FIITFolder}"
      # JWT Authentication
      JWT_SECRET_KEY: "${JWT_SECRET_KEY:-super-secret-jwt-key-for-fiit-folder-app-2024}"
      JWT_ISSUER: "${JWT_ISSUER:-fiit-folder-api}"
      JWT_AUDIENCE: "${JWT_AUDIENCE:-fiit-folder-client}"
      # Yandex Cloud S3
      YANDEX_ACCESS_KEY: "${YANDEX_ACCESS_KEY:-}"
      YANDEX_SECRET_KEY: "${YANDEX_SECRET_KEY:-}"
      YANDEX_BUCKET_NAME: "${YANDEX_BUCKET_NAME:-fiit-folder}"
      YANDEX_REGION: "${YANDEX_REGION:-ru-central1}"
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - fiit-network

  # 2. Frontend (React + Nginx)
  frontend:
    build:
      context: ./frontend/react_ts
      dockerfile: ./Dockerfile
    container_name: fiit_frontend
    restart: always
    ports:
      # –í–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç 80 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç WEB) -> –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç 80 (Nginx)
      - "${FRONTEND_EXTERNAL_PORT:-80}:80"
    environment:
      # üõë –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏ YOUR_SERVER_IP –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π IP, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞—Å—Ç –Ø–Ω–¥–µ–∫—Å
      # –ü—Ä–∏–º–µ—Ä: http://158.160.XX.XX:8080
      REACT_APP_API_URL: "http://${SERVER_IP:-localhost}:${API_EXTERNAL_PORT:-8080}"
    depends_on:
      - api
    networks:
      - fiit-network

  #################
  # 3. MongoDB Database
  mongo:
    image: mongo:6.0
    container_name: fiit_mongo
    restart: always
    # –ü–æ—Ä—Ç –ë–î –æ–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–∞—Ä—É–∂—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
    # –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ –ë–î –∏–∑–≤–Ω–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Compass), —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –Ω–∏–∂–Ω—é—é —Å—Ç—Ä–æ–∫—É:
    # ports:
    #   - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
      MONGO_INITDB_DATABASE: ${MONGO_DB_NAME:-FIITFolder}
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fiit-network

volumes:
  mongo-data:
    driver: local
  mongo-config:
    driver: local

networks:
  fiit-network:
    driver: bridge
